<!DOCTYPE html>
<html>
    <head>
        <!-- Amazon AWS SDK -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.720.0.min.js"></script>

        <!-- Mapbox API -->
        <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>

        <!-- Anno Dependencies -->
        <!--
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="https://rawgit.com/iamdanfox/anno.js/gh-pages/dist/anno.js" type="text/javascript"></script>
        <script src="https://rawgit.com/litera/jquery-scrollintoview/master/jquery.scrollintoview.js" type="text/javascript"></script>
        <link href="https://rawgit.com/iamdanfox/anno.js/gh-pages/dist/anno.css" rel="stylesheet" type="text/css" />
        -->

        <!-- Mapbox Map Stylesheet -->
        <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

        <!-- Font Awesome Icons -->
        <script src="https://kit.fontawesome.com/a246ac401c.js" crossorigin="anonymous"></script>

        <!-- Custom Styles -->
        <link rel="stylesheet" href="styles/variables.css">
        <link rel="stylesheet" href="styles/map.css">

        <!-- Mapbox Geocoder Stylesheet -->
        <link rel="stylesheet" href='/styles/mapbox-gl-geocoder.css'>

        <!-- C3 Stylesheet -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/c3@0.7.20/c3.min.css">

        <!-- Animate.css Animations -->
        <link rel="stylesheet" href="/styles/animate.min.css"/>

       <title>Access & Equity | Health Vulnerability Mapper</title>
        <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
        <link rel="manifest" href="images/site.webmanifest">

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-180195973-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-180195973-1');
        </script>

    </head>
    <body onload="onLoad()">
        <!--
        <input id='covidInput' value="cases">
        <button onclick="selectCovidData(document.getElementById('covidInput').value)">Load COVID</button>
        <input id='sviInput' value="sviOverall">
        <button onclick="selectSviData(document.getElementById('sviInput').value)">Load SVI</button>-->

        <!-- Navbar -->
        <!--<nav class="navbar navbar-expand-lg navbar-light" id="aws-navbar" style="display:none;">
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarText">
            <a href="home.html" style="text-decoration: none; color:var(--gray); font-size:21px; margin-left:26px">&#8592;</a>
          </div>
        </nav>-->

        <!-- Mapbox Map -->
        <div id='aws-map' style="height:100%; width:100%; z-index:1; position:fixed; top:0; left:0"></div>
        <div id="aws-loading-container">
            <div class="text-purple animate__animated animate__fadeInDown" id="aws-loading-title">
                COVID-19 Health Vulnerability Mapper
            </div>
            <div id="aws-spinner-container">
                <div class="spinner-border text-purple" id="aws-spinner" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div id="aws-spinner-counter-holder">
                <span id="aws-spinner-counter">0</span><span> %</span>
            </div>
        </div>

        <!-- Map Panels -->
        <div id="aws-left-panel-holder">
            <div id="aws-title-bar" onclick="toggleMenuPanel()">
                <a href="home.html"><img src="images/android-chrome-512x512.png" style="height:32px; padding-right: 20px; transform: translate(0,-2.5px)"></a>
                Health Vulnerability Map
                <div id="aws-tab-button">
                    <i id='aws-tab-icon' class="fas fa-angle-left"></i>
                </div>
            </div>


            <div class="aws-panel open" id="aws-menu-panel">
                <div class="aws-panel-section"></div>
                <div id='aws-menu-accordion-holder'>
                    <div id="aws-disclaimer">
                    This app was created with daily data in mind. Since the COVID-19 pandemic is no longer moving as quickly, we've paused our data pipeline to save costs. The COVID data presented is as-of 2/20/2021.
                    </div>    
                        <div id="aws-accordion">
                            <ul id="aws-accordion-ul">
                              <li id="aws-accordion-li">
                                <input type="checkbox">
                                <i class="aws-dropdown-icon fas fa-angle-up"></i>
                                <h2 class="aws-accordion-header"><div>COVID-19 Metrics</div><span class='aws-captions'>bar height</span></h2>
                                <div class="aws-button-group aws-covid-accordion" id="aws-covid-buttons"></div>
                              </li>
                              <li id="aws-accordion-li">
                                <input type="checkbox">
                                <i class="aws-dropdown-icon fas fa-angle-up"></i>
                                <h2 class="aws-accordion-header"><div>Vulnerability Metrics</div><span class='aws-captions'>color</span></h2>
                                <div class="aws-button-group aws-svi-accordion" id='aws-svi-buttons'></div>
                              </li>
                            </ul>
                        </div>
                    <div class="aws-divider"></div>
                    <div class="aws-panel-footer">
                        <div class="container">
                            <div class="row">
                                <div class="col-3 align-self-center aws-footer-icons">
                                    <a href="/">
                                         <i class="fas fa-home fa-lg"></i>
                                    </a>
                                </div>
                                <div class="col-3 align-self-center aws-footer-icons">
                                    <a href="https://svi.cdc.gov/" target="_blank">
                                         <i class="fas fa-info fa-lg"></i>
                                    </a>
                                </div>
                                <div class="col-3 align-self-center aws-footer-icons">
                                    <a class="nav-link" href="https://youtu.be/eWtF2rZ8ZJQ" target="_blank">
                                         <i class="fas fa-play fa-lg"></i>
                                    </a>
                                </div>
                                <div class="col-3 align-self-center aws-footer-icons">
                                    <a class="nav-link" href="/resources">
                                         <i class="fas fa-gavel fa-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="aws-panel closed" id="aws-data-panel">
            <div id='aws-data-panel-title'>
                <span>
                    <span id='aws-data-panel-county-name'>County Name,</span> <span id='aws-data-panel-state'>STATE</span>
                </span>
                <div id='aws-data-panel-x' onclick="toggleDataPanel('close')" style="cursor:pointer">
                    <i class="fas fa-times" style="color:var(--gray);"></i>
                </div>
            </div>
            <div id='aws-data-panel-current-variables'>
                <div class='aws-data-panel-current-variables-row'>
                    <span id='aws-data-panel-current-covid-name'> </span>
                    <span id='aws-data-panel-current-covid-value'> </span>
                </div>
                <div class='aws-data-panel-current-variables-row'>
                    <span id='aws-data-panel-current-svi-name'> </span>
                    <span id='aws-data-panel-current-svi-value'> </span>
                </div>
            </div>
            <div id="aws-accordion">
                <ul id="aws-accordion-ul" class='aws-data-panel-accordion'>
                    <li id="aws-accordion-li" class="aws-data-panel-accordion-item">
                        <input type="checkbox" id='aws-charts-checkbox'>
                        <i class="aws-dropdown-icon fas fa-angle-up" style="right:40px"></i>
                        <h2 class="aws-accordion-header">Charts</h2>
                        <div class="aws-button-group" id='aws-data-panel-charts-button-group'>
                            <div id='aws-data-panel-charts'>
                                <div class='aws-data-panel-line'></div>
                                <p style="padding-bottom:0; margin:0; color:var(--gray)">This County Against the US</p>
                                <p class="aws-captions">scroll to explore scatterplot</p>
                                <div id='scatterplot'></div>
                                <p id='aws-pie-chart-title' style="padding-bottom:10px; color:var(--gray);"></p>
                                <div id='pie-chart'></div>
                                <div class='aws-data-panel-line'></div>
                                <p style="padding-bottom:10px; color:var(--gray)">Mask Use</p>
                                <div id='donut-chart'></div>
                            </div>
                        </div>
                    </li>
                    <li id="aws-accordion-li" class="aws-data-panel-accordion-item">
                        <input type="checkbox" id="aws-view-all-metrics-checkbox">
                        <i class="aws-dropdown-icon fas fa-angle-up" style="right:40px"></i>
                        <h2 class="aws-accordion-header">View All Metrics</h2>
                        <div class="aws-button-group" id='aws-data-panel-all-variables-button-group'>
                             <div id='aws-data-panel-all-variables'>
                                <div id='aws-data-panel-meta-variables'></div>
                                <div class='aws-divider'></div>
                                <div id='aws-data-panel-covid-variables'></div>
                                <div class='aws-divider'></div>
                                <div id='aws-data-panel-svi-variables'></div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Map Legend -->
        <div id="aws-legend">
            <div id="aws-legend-covid-name"></div>
            <div id='aws-legend-covid-row'>
                <div id="aws-legend-covid-icon"><i class="fas fa-arrows-alt-v" style="color:var(--gray);"></i></div>
                <div>bar height</div>
            </div>
            <div id="aws-legend-svi-name"></div>
            <div id="aws-legend-svi-high-row">
                <div id="aws-legend-svi-high-patch" style="background-color:var(--purple)"></div>
                <div id="aws-legend-svi-high-name"></div>
            </div>
            <div id="aws-legend-svi-low-row">
                <div id="aws-legend-svi-low-patch" style="background-color:var(--blue)"></div>
                <div id="aws-legend-svi-low-name"></div>
            </div>
        </div>

        <div id="mobile-checker"></div>

        <script>
            /*
            * User interface code
            */

            var menuPanel;
            var tabIcon;
            var dataPanel;
            //var navbar;
            var titleBar;
            var mapControls;
            var spinnerCounter = false;
            let counterTarget = 0;
            let counterCurrent = 0;
            var counterTimer = setInterval(spinnerIncrementor, 60);

            var isMenuPanelOpen = true;
            var isDataPanelOpen = false;

            var dataPanelLoading = false;

            async function spinnerIncrementor() {
                if (counterCurrent < counterTarget) {
                    spinnerCounter.innerHTML = counterCurrent++;
                }
            }

            // animate spinner counter to number
            function setSpinnerCounter(number) {
                if (!spinnerCounter) {
                    spinnerCounter = document.getElementById('aws-spinner-counter');
                }
                counterTarget = number;
            }

            // Check if this device is a mobile device, if so, stop loading and display mobile message
            function checkIfMobile() {
                let mobileChecker = document.getElementById('mobile-checker');

                console.log(mobileChecker);
                console.log(mobileChecker.style.display)

                // if this is a mobile device
                if (mobileChecker.style.display == 'block') {
                    document.getElementById('mobile-message').style.display = 'block';
                    return true;
                }
                else {
                    return false;
                }
            }

            // Called within the onLoad function when mapbox is done loading
            function loadUserInterface() {
                menuPanel = document.getElementById('aws-menu-panel');
                tabIcon = document.getElementById('aws-tab-icon');
                dataPanel = document.getElementById('aws-data-panel');
                //navbar = document.getElementById('aws-navbar');
                titleBar = document.getElementById('aws-title-bar');
                mapControls = document.getElementsByClassName('mapboxgl-ctrl-top-right')[0];

                // populate the menu panel and data panel with display names

                // menu panel
                // covid
                let covidAccordion = document.getElementById('aws-covid-buttons')
                let covidContent = '';
                for (let variable in covidVariables) {
                    let thisName = covidVariables[variable].name;

                    /*let element = `<label class="aws-radio aws-control" onclick="selectCovidData('`+variable+`')">`+thisName+`
                        <input type="radio" name="covid-radio" id="menu-`+variable+`"/>
                        <div class="aws__indicator"></div>
                      </label>`;*/

                      let element = `<label class="aws-radio aws-control" id="label-`+variable+`" onmouseover="metricInfo('`+variable+`')" onclick="selectCovidData('`+variable+`')">`+thisName+`
                        <input type="radio" name="covid-radio" id="menu-`+variable+`"/>
                        <div class="aws__indicator"></div>
                        <span class="tooltiptext">Tooltip text</span>
                      </label>`;

                      covidContent = covidContent + element;
                }
                covidAccordion.innerHTML = covidContent;

                // svi
                let sviAccordion = document.getElementById('aws-svi-buttons')
                let sviContent = '';
                for (let variable in sviVariables) {
                    if (sviVariables[variable].choosable == "true") {
                        let thisName = sviVariables[variable].name;

                         let element = `<label class="aws-radio aws-control" id="label-`+variable+`" onmouseover="metricInfo('`+variable+`')" onclick="selectSviData('`+variable+`')">`+thisName+`
                            <input type="radio" name="svi-radio" id="menu-`+variable+`"/>
                            <div class="aws__indicator"></div>
                            <span class="tooltiptext">Tooltip text</span>
                          </label>`;

                          sviContent = sviContent + element;
                    }
                }
                sviAccordion.innerHTML = sviContent;

                // highlight the default elements
                document.getElementById("menu-covidCaseDensity").checked = true;
                document.getElementById("menu-sviOverall").checked = true;


                // data panel
                // meta info
                let metaContainer = document.getElementById('aws-data-panel-meta-variables')
                let metaDataContent = '';
                for (let variable in metaVariables) {
                    let thisName = metaVariables[variable].name;

                    let element = `<div class='aws-data-panel-all-variables-row'>
                            <span>`+thisName+`</span>
                            <span id='aws-data-panel-`+variable+`-value'> </span>
                        </div>`;

                      metaDataContent = metaDataContent + element;
                }
                metaContainer.innerHTML = metaDataContent;

                // covid
                let covidContainer = document.getElementById('aws-data-panel-covid-variables')
                let covidDataContent = '';
                for (let variable in covidVariables) {
                    let thisName = covidVariables[variable].name;

                    let element = `<div class='aws-data-panel-all-variables-row'>
                            <span>`+thisName+`</span>
                            <span id='aws-data-panel-`+variable+`-value'> </span>
                        </div>`;

                      covidDataContent = covidDataContent + element;
                }
                covidContainer.innerHTML = covidDataContent;

                // svi
                let sviContainer = document.getElementById('aws-data-panel-svi-variables')
                let sviDataContent = '';
                for (let variable in sviVariables) {
                    let thisName = sviVariables[variable].name;

                    let element = `<div class='aws-data-panel-all-variables-row'>
                            <span>`+thisName+`</span>
                            <span id='aws-data-panel-`+variable+`-value'> </span>
                        </div>`;

                      sviDataContent = sviDataContent + element;
                }
                sviContainer.innerHTML = sviDataContent;
            }

            var highlightedCountyID = null;
            // called by map.on('click','data')
            function onMapClick(e,source) {
                /*
                *   1. Highlight county on map
                *   2. Update data panel contents
                *   3. Open data panel
                */

                dataPanelLoading = true;

                // if the current selected svi layer changed, sort geoJSON by SVI again
                if (currentSviLayer != previousSviLayer) {
                    geoJSONSortedBySvi = [...geoJSON.features].sort(geoJSONSviComparator);
                    previousSviLayer = currentSviLayer;
                }
                //console.log(geoJSONSortedBySvi);

                let feature;

                if (source == 0) {
                    feature = e.features[0];
                } else {
                    feature = e;
                }

                // Highlight county on map
                if (highlightedCountyID) {
                    map.setFeatureState(
                        { source: 'data', id: highlightedCountyID },
                        { highlighted: false }
                    );
                    highlightedCountyID = null;
                }
                highlightedCountyID = feature.id;
                map.setFeatureState(
                    { source: 'data', id: highlightedCountyID },
                    { highlighted: true }
                );

                // Update C3 graphs
                let countyFips = feature.properties.fipsCovid;
                generateCharts(countyFips);

                // Update county and state names
                document.getElementById('aws-data-panel-county-name').innerHTML = feature.properties.countyName + ', ';
                document.getElementById('aws-data-panel-state').innerHTML = feature.properties.stateName;

                // Animate update
                animateIt('#aws-data-panel-county-name','bounce');

                // Update currently selected COVID and SVI displays
                document.getElementById('aws-data-panel-current-covid-name').innerHTML = covidVariables[currentCovidLayer].name;

                let covidValue = document.getElementById('aws-data-panel-current-covid-value');
                let layerValue = feature.properties[currentCovidLayer];
                if (currentCovidLayer == 'covidDeathDensity' || currentCovidLayer == 'covidCaseDensity') {
                    // display text as "one in every ____ people"
                    covidValue.innerHTML = oneInEvery(layerValue);
                } else {
                    covidValue.innerHTML = numberWithCommas(layerValue);
                }


                document.getElementById('aws-data-panel-current-svi-name').innerHTML = sviVariables[currentSviLayer].name;

                let sviPercent = formatOutput(feature, currentSviLayer);
                console.log(sviPercent);

                /*if (currentSviLayer in sectionNames) {
                    sviPercent = parseFloat( feature.properties[ currentSviLayer ] );
                } else if (currentSviLayer != 'sviIncome') {
                    sviPercent = ( parseFloat( feature.properties[ currentSviLayer ] ) * 100 );
                } else {
                    sviPercent = parseFloat( feature.properties[ currentSviLayer ]);
                }

                if (['sviOverall', 'sviSocioeconomics', 'sviHouseholdComposition', 'sviMinority', 'sviHousing'].indexOf(currentSviLayer) != -1) {
                    sviPercent = sviPercent.toFixed(2) + "th Percentile";
                } else if (currentSviLayer != 'sviIncome') {
                    sviPercent = sviPercent.toFixed(2) + "%";
                } else {
                    sviPercent = "$" + sviPercent.toFixed(2);
                }*/



                document.getElementById('aws-data-panel-current-svi-value').innerHTML = sviPercent;

                // Update all variables display
                let dataPanelAllCovidElements = document.getElementById('aws-data-panel-covid-variables').children;
                let dataPanelAllSviElements = document.getElementById('aws-data-panel-svi-variables').children;
                let dataPanelAllMetaElements = document.getElementById('aws-data-panel-meta-variables').children;

                let metaKeys = Object.keys(metaVariables);
                for (let i = 0; i < dataPanelAllMetaElements.length; i++) {
                    let rowChildren = dataPanelAllMetaElements[i].children;
                    let value = rowChildren[1];
                    let thisKey = metaKeys[i];
                    let content = feature.properties[ thisKey ];
                    if (thisKey == 'population') {
                        content = numberWithCommas(content);
                    }
                    value.innerHTML = content;
                }

                let covidKeys = Object.keys(covidVariables);
                for (let i = 0; i < dataPanelAllCovidElements.length; i++) {
                    let rowChildren = dataPanelAllCovidElements[i].children;
                    let value = rowChildren[1];
                    let thisKey = covidKeys[i];
                    if (thisKey == 'cases' || thisKey == 'deaths') {
                        value.innerHTML = numberWithCommas( feature.properties[ thisKey ] );
                    }
                    else {
                        value.innerHTML = oneInEvery( feature.properties[ thisKey ] );
                    }
                }

                /*let sviKeys = Object.keys(sviVariables);
                for (let i = 0; i < dataPanelAllSviElements.length; i++) {
                    let rowChildren = dataPanelAllSviElements[i].children;
                    let value = rowChildren[1];
                    let thisKey = sviKeys[i];
                    let content;
                    if (thisKey in sectionNames) {
                        content = parseFloat( feature.properties[ thisKey ] ) + "";
                    } else if (thisKey != 'sviIncome') {
                        content = ( parseFloat( feature.properties[ thisKey ] ) * 100 ) + "";
                    } else {
                        content = parseFloat( feature.properties[ thisKey ]) + "";
                    }
                    if (thisKey == ('sviOverall' || 'sviSocioeconomics'||'sviHouseholdComposition' || 'sviMinority'||'sviHousing')) {
                        content = content.substring(0,4) + "th Percentile";
                    } else if (thisKey != 'sviIncome') {
                        content = content.substring(0,4) + "%";
                    }
                    value.innerHTML = content.substring(0,4);
                }*/

                let sviKeys = Object.keys(sviVariables);
                for (let i = 0; i < dataPanelAllSviElements.length; i++) {
                    let rowChildren = dataPanelAllSviElements[i].children;
                    let value = rowChildren[1];
                    let thisKey = sviKeys[i];

                    value.innerHTML = formatOutput(feature, thisKey);
                }

                // re-enable cursor!
                document.getElementById("aws-map").classList.remove('cursor-progress')

                // Open data panel
                toggleDataPanel('open');

                dataPanelLoading = false;
            }

            function loadSpinner() {
                clearInterval(counterTimer);
                document.getElementById('aws-loading-container').style.display = "none";
            }

            /* Toggles the menu panel open and close
            * When the menu panel is closed:
            *   - the navbar also goes away
            *   - title bar and map controls shift up to fill in space left by navbar
            * When the menu panel is opened:
            *   - closes the data panel
            *   - title bar and map controls shift down to accomodate navbar
            */
            function toggleMenuPanel(forceState) {

                if (forceState == 'open') {
                    menuPanel.classList.remove('closed');
                    menuPanel.classList.add('open');

                    //navbar.classList.remove('collapsed');
                    //navbar.classList.add('open');

                    titleBar.classList.remove('raised');
                    titleBar.classList.add('lowered');

                    mapControls.classList.remove('raised');
                    mapControls.classList.add('lowered');

                    tabIcon.classList.remove('down');
                    tabIcon.classList.add('left');

                    toggleDataPanel('closed');

                    isMenuPanelOpen = true;
                }
                else if (isMenuPanelOpen || forceState == 'closed') {
                    menuPanel.classList.remove('open');
                    menuPanel.classList.add('closed');

                    //navbar.classList.remove('open');
                    //navbar.classList.add('collapsed');

                    titleBar.classList.remove('lowered');
                    titleBar.classList.add('raised');

                    mapControls.classList.remove('lowered');
                    mapControls.classList.add('raised');

                    tabIcon.classList.remove('left');
                    tabIcon.classList.add('down');

                    isMenuPanelOpen = false;
                }
                else {
                    menuPanel.classList.remove('closed');
                    menuPanel.classList.add('open');

                    //navbar.classList.remove('collapsed');
                    //navbar.classList.add('open');

                    titleBar.classList.remove('raised');
                    titleBar.classList.add('lowered');

                    mapControls.classList.remove('raised');
                    mapControls.classList.add('lowered');

                    tabIcon.classList.remove('down');
                    tabIcon.classList.add('left');

                    toggleDataPanel('closed');

                    isMenuPanelOpen = true;
                }
            }

            // toggles the data panel open and close
            // closes the menu panel when opening the data panel too
            function toggleDataPanel(forceState) {

                if (forceState == 'open') {
                    dataPanel.classList.remove('closed');
                    dataPanel.classList.add('open');

                    toggleMenuPanel('closed');

                    // shift map to keep visualization centered
                    map.easeTo({
                        padding: {
                            right: '600', // should match width in px of menu panel
                        },
                        duration: 500 // should match var(--slow-transition)
                    });

                    isDataPanelOpen = true;
                }
                else if (forceState == 'closed' || isDataPanelOpen) {
                    dataPanel.classList.remove('open');
                    dataPanel.classList.add('closed');

                    // shift map to keep visualization centered
                    map.easeTo({
                        padding: {
                            right: '0', // should match width in px of menu panel
                        },
                        duration: 500 // should match var(--slow-transition)
                    });

                    isDataPanelOpen = false;
                }
                else {
                    dataPanel.classList.remove('closed');
                    dataPanel.classList.add('open');

                    toggleMenuPanel('closed');

                    // shift map to keep visualization centered
                    map.easeTo({
                        padding: {
                            right: '600', // should match width in px of menu panel
                        },
                        duration: 500 // should match var(--slow-transition)
                    });

                    isDataPanelOpen = true;
                }
            }

            // handles the tooltips for each metric on the menu panel
            function metricInfo(metric){

                var infos = {
                    cases: "Cumulative total # of cases within the county",//
                    deaths: "Cumulative total # of deaths currently within the county",//
                    covidCaseDensity: "Cumulative # of cases per county resident",
                    covidDeathDensity: "Cumulative # of deaths per county resident",//
                    sviOverall: "Social vulnerability overall ranking",//
                    sviSocioeconomics:"Aggregate of poverty, income, education, etc.",//
                    sviHouseholdComposition:"Aggregate of age, disability, household composition, etc.",//
                    sviMinority:"Aggregate of minority status and English abilities",//
                    sviHousing:"Aggregate of crowding, mobile-home/vehicle status, etc.",//
                    sviPovertyPercentile:"Population below the poverty line",//
                    sviUnemploymentRatePercentile:"Population (age 16+) unemployed",//
                    sviIncome:"Average annual income per person",//
                    sviIncomePercentile:"Average annual income per person (Percentile)",//
                    sviNoHighSchoolPercentile:"Population with no high school diploma (age 25+)",//
                    sviMinorityPercentile:"Minority population (all except non-Hispanic Whites)",//
                    sviEnglishLackingPercentile:"Population (age 5+) who speak English 'less than well'",//
                    sviNoVehiclePercentile:"Households with no vehicle available",//
                    sviInstitutionalizedGroupQuartersPercentile:"Population in correctional, nursing, or mental institutions",//
                    sviAge65OverPercentile:"Population aged 65 and older",//
                    sviAge17UnderPercentile:"Population aged 17 and younger",//
                    sviDisabledPercentile:"Noninstitutionalized population with a disability",
                    sviSingleParentPercentile:"Single parent households with children under 18",
                    sviUninsuredPercent:"Uninsured noninstitutionalized population",
                    sviMobileHousingPercentile: "Population living in mobile housing structures",
                    sviCrowdingPercentile: "Housing units with more than one person per room",
                }

                var tooltip = document.getElementById("label-" + metric).children[2];
                tooltip.innerHTML = infos[metric];
            }

            const animateIt = (element, animation, prefix = 'animate__') =>
              // We create a Promise and return it
              new Promise((resolve, reject) => {
                const animationName = `${prefix}${animation}`;
                const node = document.querySelector(element);

                node.classList.add(`${prefix}animated`, animationName);

                // When the animation ends, we clean the classes and resolve the Promise
                function handleAnimationEnd() {
                  node.classList.remove(`${prefix}animated`, animationName);
                  node.removeEventListener('animationend', handleAnimationEnd);

                  resolve('Animation ended');
                }

                node.addEventListener('animationend', handleAnimationEnd);
              });

        </script>

        <script>
            /*
            * Mapping and data code
            */

            /*
            *Declare some global variables
            */

            // For Mapbox
            var map; // API managed var that stores the properties of the map
            const mapboxStyleSheet = 'mapbox://styles/novembersnows/ckd7168tu0hrg1it6b2lv19mb' // stylesheet location

            // For our data
            const pathToSvi = '/data/svi/2018_svi_with_coords.json';
            const pathToSviQuartiles = 'data/svi/svi_quartiles.json';
            const pathToMaskUse = '/data/mask_use/mask_use_by_county_2.json';
            //const pathToMaskQuartiles = '/data/mask_use/mask_quartiles.json';
            const pathToCovidVariables = '/data/variable_names/covid_variables.json';
            const pathToSviVariables = '/data/variable_names/svi_variables.json';
            const pathToMetaVariables = '/data/variable_names/meta_variables.json';
            var covid; // stores the covid data JSON object
            var maxCases;
            var maxDeaths;
            var maxCasesDensity;
            var maxDeathsDensity;
            /*var casesQ1; // first quartile value of covid case count
            var casesQ3; // third quartile value of covid case count
            var deathsQ1;
            var deathsQ3;
            var casesDensityQ1;
            var casesDensityQ3;
            var deathsDensityQ1;
            var deathsDensityQ3;*/
            var svi; // stores the SVI data JSON object
            var sviQuartiles; // stores the SVI quartiles data JSON object
            var maskUse; // stores the mask use data JSON object
            //var maskQuartiles;
            var geoJSON; // stores all of this ^ data together in one object
            var geoJSONSortedBySvi;
            var covidVariables; // documents the variable name and display name of each covid variable
            var sviVariables; // documents the variable name and display name of each svi variable
            var metaVariables; // documents the variable name and display name of each meta variable (FIPS, population, etc)

            // for user interaction
            var currentCovidLayer = 'cases';
            var currentSviLayer = 'sviOverall';
            var previousSviLayer = undefined;

            // For AWS S3
            const S3_SIGNED_URL = '{signed_url}'; // INSERTED BY WHISKERS RENDERING ENGINE WHEN MAP.HTML IS SENT FROM SERVER
            const S3_BUCKET_NAME = 'us-counties-cases-datas3bucket-52y13214tdyo';
            var S3_BUCKET = new AWS.S3({
                accessKeyId: accessKeyId,
                secretAccessKey: secretAccessKey,
                params: {
                    Bucket: S3_BUCKET_NAME
                }
            });


            /*
            * The "main" onLoad function (code starts executing here)
            * Loads everything on the web app
            */
            async function onLoad() {
                /*
                * 1. Retrieve COVID data from S3
                * 2. Retrieve SVI data from server
                * 3. Retrieve mask use data from server
                * 4. Format and save data in global variables
                * 5. Load Mapbox
                * 6. Load user interface
                */

                setSpinnerCounter(75);

                // Retrieve COVID data from S3
                covid = await getMostRecentCovid();

                setSpinnerCounter(85);

                // Retrieve SVI data from SVI data from server
                svi = await fetchFromServer(pathToSvi);
                sviQuartiles = await fetchFromServer(pathToSviQuartiles);

                setSpinnerCounter(95);

                // Retrieve mask use data from server
                maskUse = await fetchFromServer(pathToMaskUse);
                //maskQuartiles = await fetchFromServer(pathToMaskQuartiles);

                // Retrieve variable name files from server
                sviVariables = await fetchFromServer(pathToSviVariables);
                covidVariables = await fetchFromServer(pathToCovidVariables);
                metaVariables = await fetchFromServer(pathToMetaVariables);
                

                // Format data
                covid = JSON.parse(CSVtoJSON(covid));
                
                // DEBUG
                console.log(covid);
                console.log(svi);

                let trimmedData = await trimData(covid, svi);
                covid = trimmedData[0];
                svi = trimmedData[1];
                
                console.log(covid);

                setSpinnerCounter(98);

                /*
                // Generate interquartile ranges for COVID data
                await calculateCovidIQR();
                */
                // Load Mapbox
                loadMapbox();

                // Load User Interface
                loadUserInterface();

                loadSpinner();

                /*var intro =   new Anno([

                    {
                        target:'#aws-covid-buttons',
                        content: "Choose a COVID-19 metric!",
                        position: 'bottom'
                    },
                    {
                        target: '.mapboxgl-ctrl-geocoder--input',
                        content: "Choose a SVI vulnerability metric! For more information on each metric, blah blah blah.",
                        position:'bottom'
                    },
                    {
                        target: '#aws-svi-buttons',
                        content: "Now, click on any 3D bar on the map to view details specific to that county!",
                        position: 'top'
                    }

                ]);*/

                /*var intro =   new Anno([

                    {
                        target:'#aws-left-panel-holder',
                        content: "Choose a COVID variable.",
                        position: {
                            top:"150px",
                            left:"400px"
                        },
                        arrowPosition: 'center-left',
                    },
                    {
                        target:'#aws-left-panel-holder',
                        content: "Choose a vulnerability variable.",
                        position: {
                            top:"400px",
                            left:"400px"
                        },
                        arrowPosition: 'center-left',
                    },
                    {
                        target:'.mapboxgl-ctrl-geocoder',
                        content: "Locate your county.",
                        position: "left",
                    },
                ]);

                intro.show(); */
                //console.log("showed");
                //intro.hide();
                //intro.chainIndex(1).show();
                //intro.show();
            }


            /*
            * Mapbox Functions
            */

            // Function: initializes the map
            async function loadMapbox() {
                // apply the access token to log in
                mapboxgl.accessToken = 'pk.eyJ1Ijoibm92ZW1iZXJzbm93cyIsImEiOiJja2Q0djN1cGYwYWlnMnBydDZiOTgzM3MzIn0.9ftbURZI671OQV91OhgDBQ';

                // make the map
                map = new mapboxgl.Map({
                    container: 'aws-map', // html element id to put the map in
                    style: mapboxStyleSheet,
                    center: [-95, 37], // starting position [lng, lat]
                    pitch: 40, // pitch in degrees
                    zoom: 3.84, // starting zoom
                });

                // after the map loads:
                map.on('load', function() {
                    // Expand map to fill its container
                    map.resize();

                    // load all of our data into Mapbox
                    addSources();

                    let layers = map.getStyle().layers;
                    // Find the index of the first symbol layer in the map style
                    let firstSymbolId;
                    for (var i = 0; i < layers.length; i++) {
                        if (layers[i].type === 'symbol') {
                            firstSymbolId = layers[i].id;
                            break;
                        }
                    }

                    // add the data layer
                    map.addLayer({
                            'id':'data',
                            'type': 'fill-extrusion',
                            'source':'data',
                            'paint': {
                                'fill-extrusion-height': [
                                    'interpolate', ['linear'], ['zoom'],
                                    1, ['to-number',['get','height']],
                                    13, 1
                                  ],
                                'fill-extrusion-color': [
                                      'case', // if statement
                                      ['==', ['feature-state', 'highlighted'], false], // if not highlighted
                                      [  // then check if hovered
                                        'case',
                                        ['==', ['feature-state', 'hover'], false], // if not hovered
                                            [ // use SVI coloring
                                            'interpolate', ['linear'], ['to-number',['get','color']],
                                            0, '#AEEEFF',
                                            0.3, '#ACD0FC',
                                            0.6, '#AAB1F8',
                                            1, '#A573F0',
                                            ],
                                        ['==', ['feature-state', 'hover'], true], // if hovered
                                        '#C6DEA6', // then give hovored county a color
                                        [
                                            'interpolate', ['linear'], ['to-number',['get','color']],
                                            0, '#AEEEFF',
                                            0.3, '#ACD0FC',
                                            0.6, '#AAB1F8',
                                            1, '#A573F0',
                                          ], // use SVI color by default
                                      ],
                                      ['==', ['feature-state', 'highlighted'], true], // if highlighted
                                      '#C6DEA6', // then highlighted in color

                                      [ // check again by default
                                        'case',
                                        ['==', ['feature-state', 'hover'], false], // if not hovered
                                            [ // use SVI coloring
                                            'interpolate', ['linear'], ['to-number',['get','color']],
                                            0, '#AEEEFF',
                                            0.3, '#ACD0FC',
                                            0.6, '#AAB1F8',
                                            1, '#A573F0',
                                            ],
                                        ['==', ['feature-state', 'hover'], true], // if hovered
                                        '#C6DEA6', // then give hovored county a color
                                        [
                                            'interpolate', ['linear'], ['to-number',['get','color']],
                                            0, '#AEEEFF',
                                            0.3, '#ACD0FC',
                                            0.6, '#AAB1F8',
                                            1, '#A573F0',
                                          ], // use SVI color by default
                                      ],
                                ],
                            },
                        },
                        firstSymbolId);


                        // when the map is done loading,
                        // immediately render COVID case count and SVI overall data
                        selectCovidData('covidCaseDensity');
                        selectSviData('sviOverall');

                        // add a "you can click on a county for more info" popup to the map
                        new mapboxgl.Popup()
                            .setLngLat([-88.3249, 52])
                            .setHTML("Click on any county for more data and analysis!<br>&cudarrr;")
                            .addTo(map);
                });

                // clicking on a datapoint functionality!ðŸ’¡

                // when the map itself is clicked, clear the highlighted county, but only if the data panle is not still loading
                map.on('click', function(e) {
                    if (!dataPanelLoading) {
                        map.setFeatureState(
                            { source: 'data', id: highlightedCountyID },
                            { highlighted: false }
                        );
                        highlightedCountyID = null;

                        // close data panel
                        toggleDataPanel('closed');
                    }
                });

                map.on('click', 'data', function(e) {
                    // set cursor to wait
                    document.getElementById("aws-map").classList.add('cursor-progress');
                    onMapClick(e, 0);
                });

                // hovering over a datapoint functionality!
                var hoveredCountyID = null;
                // when the mouse moves
                map.on('mousemove', 'data', function(e) {
                    if (hoveredCountyID) {
                        map.setFeatureState(
                            { source: 'data', id: hoveredCountyID },
                            { hover: false }
                        );
                    }

                    hoveredCountyID = e.features[0].id;

                    map.setFeatureState(
                        { source: 'data', id: hoveredCountyID },
                        { hover: true }
                    );
                });

                // When the mouse leaves, update previously hovered feature.
                map.on('mouseleave', 'data', function() {
                    //console.log("mouse left")
                    if (hoveredCountyID) {
                        map.setFeatureState(
                            { source: 'data', id: hoveredCountyID },
                            { hover: false }
                        );
                    }
                    hoveredCountyID = null;
                });

                /*map.on('click', 'data', function(e) {

                    var countyName = "<p>County: " + e.features[0].properties.countyName + "</p>";
                    var height = "<p>Height: " + e.features[0].properties.height + "</p>";
                    var cases = "<p>Cases: " + e.features[0].properties.cases + "</p>";
                    var sviOverall = "<p>SVI: " + e.features[0].properties.sviOverall + "</p>";
                    var fipsCovid = "<p>fipsCovid: " + e.features[0].properties.fipsCovid + "</p>";
                    var fipsSvi = "<p>fipsSvi: " + e.features[0].properties.fipsSvi + "</p>";
                    var maskNever = "<p>Never Use Masks: " + e.features[0].properties.maskNever + "</p>";
                    var maskRarely = "<p>Rarely Use Masks: " + e.features[0].properties.maskRarely + "</p>";
                    var maskSometimes = "<p>Sometimes Use Masks: " + e.features[0].properties.maskSometimes + "</p>";
                    var maskFrequently = "<p>Frequently Use Masks: " + e.features[0].properties.maskFrequently + "</p>";
                    var maskAlways = "<p>Always Use Masks: " + e.features[0].properties.maskAlways + "</p>";

                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(countyName + height + cases + sviOverall + fipsCovid + fipsSvi + maskNever + maskRarely + maskSometimes + maskFrequently + maskAlways)
                        .addTo(map);
                    });
                });*/

                function forwardGeocoder(query) {
                    let matchingFeatures = [];
                    for (let i = 0; i < covid.length; i++) {
                        let feature = svi[i];
                        // handle queries with different capitalization than the source data by calling toLowerCase()
                        let location = feature.LOCATION.toLowerCase().search(query.toLowerCase()) !== -1;
                        let county = feature.COUNTY.toLowerCase().search(query.toLowerCase()) !== -1;
                        let state = feature.STATE.toLowerCase().search(query.toLowerCase()) !== -1;
                        let stateAbbrev = feature.ST_ABBR.toLowerCase().search(query.toLowerCase()) !== -1;
                        let countySpaceState = (feature.COUNTY + " " + feature.STATE).toLowerCase().search(query.toLowerCase()) !== -1;
                        let countySpaceStateAbbrev = (feature.COUNTY + " " + feature.ST_ABBR).toLowerCase().search(query.toLowerCase()) !== -1;
                        let countyCommaState = (feature.COUNTY + ", " + feature.STATE).toLowerCase().search(query.toLowerCase()) !== -1;
                        let countyCommaStateAbbrev = (feature.COUNTY + ", " + feature.ST_ABBR).toLowerCase().search(query.toLowerCase()) !== -1;

                        if (location || county || state || stateAbbrev || countySpaceState || countySpaceStateAbbrev || countyCommaState || countyCommaStateAbbrev) {
                            // add a tree emoji as a prefix for custom data results
                            // using carmen geojson format: https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                            feature['place_name'] = 'âœ”ï¸ ' + feature.LOCATION;
                            feature['center'] = [parseFloat(svi[i].long), parseFloat(svi[i].lat)];
                            feature['index'] = i;
                            matchingFeatures.push(feature);
                        }
                    }
                    //console.log(matchingFeatures)
                    return matchingFeatures;
                }

                var geocoder = new MapboxGeocoder({
                        accessToken: mapboxgl.accessToken,
                        marker: {
                            color: '#A573F0',
                        },
                        mapboxgl: mapboxgl,
                        countries: 'us',
                        localGeocoder: forwardGeocoder,
                        placeholder: 'Search For Your County',
                        zoom: 8,
                    });

                // Add search bar
                map.addControl(geocoder);

                var geocoderInUse = false;
                var geocoderResult;

                geocoder.on('result', function(e) {
                    // set cursor to wait
                    document.getElementById("aws-map").classList.add('cursor-progress');

                    geocoderInUse = true;
                    geocoderResult = e;
                    console.log(geocoderResult)
                })

                map.on('moveend', function(e){
                    //console.log('moveend')
                    //console.log(geocoderInUse)
                    if(geocoderInUse){
                        let searchedFeature = geoJSON.features[geocoderResult.result.index];
                        onMapClick(searchedFeature, 1);

                        geocoderInUse = false;
                   }
                });

                // Add zoom and tilt controls
                let nav = new mapboxgl.NavigationControl({
                    visualizePitch: true,
                });
                map.addControl(nav, 'top-right');

                // Add geolocate button
                map.addControl(new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                }));
            }

            // Function: loads COVID, SVI, and mask use data into Mapbox
            function addSources() {
                // first step is to consolidate all our data into one big ol' GEOJSON object

                geoJSON = [];

                for (var i = 0; i < covid.length; i++) {
                    var thisCovidFeature = covid[i];
                    var thisSviFeature = svi[i];
                    var thisMaskUseFeature = maskUse[i];


                    var longitude = parseFloat(thisSviFeature.long);
                    var latitude = parseFloat(thisSviFeature.lat);
                    var featureGeoJson =
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Polygon',
                                    'coordinates': [[
                                        [longitude+0.075,latitude+0.075],
                                        [longitude+0.075,latitude-0.075],
                                        [longitude-0.075,latitude-0.075],
                                        [longitude-0.075,latitude+0.075],
                                        [longitude+0.075,latitude+0.075]
                                        ]],
                                },
                                'id': i,
                                'highlighted':false,
                                'hovered':false,
                                'properties': {
                                    // General info
                                    'countyName': thisCovidFeature.county,
                                    'stateName': thisCovidFeature.state,
                                    'stateAbbrev': thisSviFeature.ST_ABBR,
                                    'population': thisSviFeature.E_TOTPOP,
                                    'fipsCovid': thisCovidFeature.fips, // used for data alignment checking
                                    'fipsSvi': thisSviFeature.FIPS, // used for data alignment checking
                                    'longitude': longitude,
                                    'latitude': latitude,

                                    // COVID
                                    'cases': thisCovidFeature.cases,
                                    'deaths': thisCovidFeature.deaths,
                                    'covidCaseDensity': (thisCovidFeature.cases / thisSviFeature.E_TOTPOP),
                                    'covidDeathDensity': (thisCovidFeature.deaths / thisSviFeature.E_TOTPOP),

                                    // SVI Main Indices
                                    'sviOverall': thisSviFeature.RPL_THEMES,
                                    'sviSocioeconomics': thisSviFeature.RPL_THEME1,
                                    'sviHouseholdComposition': thisSviFeature.RPL_THEME2,
                                    'sviMinority': thisSviFeature.RPL_THEME3,
                                    'sviHousing': thisSviFeature.RPL_THEME4,
                                    // Socioeconomic variables
                                    'sviPovertyPercentile': thisSviFeature.EPL_POV,
                                    'sviPovertyPercent': thisSviFeature.EP_POV,
                                    'sviUnemploymentRatePercentile': thisSviFeature.EPL_UNEMP,
                                    'sviUnemploymentRate': thisSviFeature.EP_UNEMP,
                                    'sviIncome': thisSviFeature.E_PCI,
                                    'sviIncomePercentile': thisSviFeature.EPL_PCI,
                                    'sviNoHighSchoolPercentile': thisSviFeature.EPL_NOHSDP,
                                    'sviNoHighSchoolPercent': thisSviFeature.EP_NOHSDP,
                                    // Minority status variables
                                    'sviMinorityPercentile': thisSviFeature.EPL_MINRTY,
                                    'sviMinorityPercent': thisSviFeature.EP_MINRTY,
                                    'sviEnglishLackingPercentile': thisSviFeature.EPL_LIMENG,
                                    'sviEnglishLackingPercent': thisSviFeature.EP_LIMENG,
                                    // Housing variables
                                    'sviMobileHousingPercentile': thisSviFeature.EPL_MOBILE,
                                    'sviMobileHousingPercent': thisSviFeature.EP_MOBILE,
                                    'sviCrowdingPercentile': thisSviFeature.EPL_CROWD,
                                    'sviCrowdingPercent': thisSviFeature.EP_CROWD,
                                    'sviNoVehiclePercentile': thisSviFeature.EPL_NOVEH,
                                    'sviNoVehiclePercent': thisSviFeature.EP_NOVEH,
                                    'sviInstitutionalizedGroupQuartersPercentile': thisSviFeature.EPL_GROUPQ,
                                    'sviInstitutionalizedGroupQuartersPercent': thisSviFeature.EP_GROUPQ,
                                    // Household composition and disability variables
                                    'sviAge65OverPercentile': thisSviFeature.EPL_AGE65,
                                    'sviAge65OverPercent': thisSviFeature.EP_AGE65,
                                    'sviAge17UnderPercentile': thisSviFeature.EPL_AGE17,
                                    'sviAge17UnderPercent': thisSviFeature.EP_AGE17,
                                    'sviDisabledPercentile': thisSviFeature.EPL_DISABL,
                                    'sviDisabledPercent': thisSviFeature.EP_DISABL,
                                    'sviSingleParentPercentile':thisSviFeature.EPL_SNGPNT,
                                    'sviSingleParentPercent':thisSviFeature.EP_SNGPNT,
                                    // Other variables
                                    'sviUninsuredPercent': thisSviFeature.EP_UNINSUR,

                                    // Mask use
                                    'maskNever': ((i < maskUse.length) ? thisMaskUseFeature.NEVER : null),
                                    'maskRarely': ((i < maskUse.length) ? thisMaskUseFeature.RARELY : null),
                                    'maskSometimes': ((i < maskUse.length) ? thisMaskUseFeature.SOMETIMES : null),
                                    'maskFrequently': ((i < maskUse.length) ? thisMaskUseFeature.FREQUENTLY : null),
                                    'maskAlways': ((i < maskUse.length) ? thisMaskUseFeature.ALWAYS : null),

                                    // Visuals (defined when rendering each layer)
                                    'height': null,
                                    'color': null,
                                },
                            };
                        geoJSON.push(featureGeoJson);
                }

                // add header
                geoJSON = {
                        'type': 'FeatureCollection',
                        'features': geoJSON,
                    };

                // Finally, add the data to the map
                map.addSource('data', {
                                    'type': 'geojson',
                                    'data': geoJSON
                                });
            }

            /*
            * Mapbox Control Functions
            */

            // selects a new COVID variable to display (changes the height of the bars)
            // Options: 'cases', 'deaths', 'covidCaseDensity', 'covidDeathDensity'
            function selectCovidData(newLayerName) {

                // Depending on which data layer, interpolate the heights differently
                let inMin = 0;
                let inMax = 1;
                let outMin = 1000;
                let outMax = 1000000;

                // display heights by interpolating between first and third quartile
                if (newLayerName == 'cases') {
                    //inMax = maxCases;
                    inMin = 0;
                    inMax = maxCases;
                }
                else if (newLayerName == 'deaths') {
                    //inMax = maxDeaths;
                    inMin = 0;
                    inMax = maxDeaths;
                }
                else if (newLayerName == 'covidCaseDensity') {
                    inMin = 0;
                    inMax = maxCasesDensity;
                }
                else if (newLayerName == 'covidDeathDensity') {
                    inMin = 0;
                    inMax = maxDeathsDensity;
                }
                // if a mask layer is chosen
                else if (newLayerName.includes('mask')) {
                    let layerDescriptor = newLayerName.replace('mask','').toUpperCase();
                    inMin = 0; //maskQuartiles[0][layerDescriptor];
                    inMax = 1; //maskQuartiles[1][layerDescriptor];
                }

                // update the 'height' property on every data point to reflect the new COVID variable
                for (var i = 0; i < geoJSON.features.length; i++) {

                    let value = geoJSON.features[i].properties[newLayerName];

                    let newHeight = interpolate(value, inMin, inMax, outMin, outMax);

                    geoJSON.features[i].properties.height = newHeight;
                    //console.log(geoJSON.features[i].properties.fipsCovid + " " + newHeight);
                }

                // update the map
                map.getSource('data').setData(geoJSON);

                // update the legend
                updateLegend(newLayerName,'');

                // update the global variable
                currentCovidLayer = newLayerName;
            }

            function selectSviData(newLayerName) {

                let inMin = 0;
                let inMax = 1;
                let outMin = 0;
                let outMax = 1;

                // if a mask layer is chosen
                if (newLayerName.includes('mask')) {
                    let layerDescriptor = newLayerName.replace('mask','').toUpperCase();
                    inMin = 0; //maskQuartiles[0][layerDescriptor];
                    inMax = 1; //maskQuartiles[1][layerDescriptor];
                }
                // otherwise if its an SVI layer
                //else {
                    /*inMin = sviQuartiles[0][newLayerName]; // first quartile value for that SVI variable
                    inMax = sviQuartiles[1][newLayerName]; // third quartile value for that SVI variable*
                    inMin = 0;
                    inMax = 1;
                }*/

                if (newLayerName == 'sviIncome') {
                    inMin = 22760; // per capita income national first quartile
                    inMax = 30112.5; // per capita income national third quartile
                }

                if (newLayerName == 'sviUninsuredPercent') { // same principle as sviIncome above ^
                    inMin = 6.2;
                    inMax = 12.7;
                }

                // update the 'color' property on every data point to reflect the new SVI variable
                for (var i = 0; i < geoJSON.features.length; i++) {
                    let value = geoJSON.features[i].properties[newLayerName];
                    let newColor = interpolate(value, inMin, inMax, outMin, outMax);

                    if (newLayerName == 'sviIncomePercentile') {
                        newColor = 1 - newColor;
                    }

                    geoJSON.features[i].properties.color = newColor;
                }

                // update the map
                map.getSource('data').setData(geoJSON);

                // update the legend
                updateLegend('',newLayerName);

                // update the global variable
                currentSviLayer = newLayerName;
            }

            function updateLegend(covidLayer, sviLayer) {

                if (sviLayer != '') {
                    let sviLayerName = sviVariables[sviLayer].short_name;
                    let sviHigh = sviVariables[sviLayer].high_name;
                    let sviLow = sviVariables[sviLayer].low_name;
                    document.getElementById('aws-legend-svi-name').innerHTML = sviLayerName;
                    document.getElementById('aws-legend-svi-high-name').innerHTML = sviHigh.toLowerCase();
                    document.getElementById('aws-legend-svi-low-name').innerHTML = sviLow.toLowerCase();
                }

                if (covidLayer != '') {
                    covidLayerName = covidVariables[covidLayer].short_name;
                    document.getElementById('aws-legend-covid-name').innerHTML = covidLayerName;
                }
            }

            /*
            * Data Retrieval Functions
            */

            async function fetchFromServer(file) {
                const request = new Request(file);
                var data = await fetch(request)
                    .then(response => response.json());
                return data;
            }

            function trimData(covid, svi) {
                let trimmedCovid = [];
                let trimmedSvi = [];

                maxCases = 0;
                maxDeaths = 0;
                maxCasesDensity = 0;
                maxDeathsDensity = 0;

                // only keep COVID data from the mainland US
                let listOfAddedFips = [];
                for (let i = 1; i < covid.length; i++) {
                    let previous = covid[i-1];
                    let current = covid[i];
                    let previousFips = previous.fips;
                    let currentFips = current.fips;

                    if (previousFips != currentFips && isCountyMainlandUs(previous.fips) && ( listOfAddedFips.indexOf(parseInt(previousFips)) == -1 ) ) {
                        trimmedCovid.push(previous);
                        listOfAddedFips.push(parseInt(previousFips));
                    }
                }

                // check if the browser is chrome. If not, create a deep copy of the sorted trimmedCovid array to make sure elements stay sorted
                let covidDeepCopy;
                if (isChrome()) {
                    // sort the COVID data in order by county FIPS
                    // sort in place
                    trimmedCovid.sort(covidFipsComparator);
                    trimmedCovid.reverse();
                } else {
                    // sort the COVID data in order by county FIPS
                    covidDeepCopy = [...trimmedCovid.sort(covidFipsComparator)];
                    covidDeepCopy.reverse();
                    // reassign sorted data back to trimmedCovid for use down the line
                    trimmedCovid = [...covidDeepCopy];
                }
                trimmedSvi = svi;

                // discard datapoints that do not have equivalents in the other dataset
                let length = Math.min(trimmedCovid.length, trimmedSvi.length);
                for (let i = 0; i < length; i++) {
                    try {
                        let thisCovid = trimmedCovid[i];
                        let thisSvi = trimmedSvi[i];

                        //console.log("i = "+i+"; thisCovid="+thisCovid.fips+" and thisSvi="+thisSvi.FIPS);

                        /*if (i==1654) {
                            console.log(trimmedCovid);
                            console.log(trimmedSvi);
                        }*/

                        // if county fips doesn't exist, throw that datapoint out
                        if (thisCovid.fips == "") {
                            //console.log("Threw out county at i= "+i+" because it is a blank");
                            trimmedCovid.splice(i,1);
                            i--;
                            //console.log("Shifted i down to "+i);
                        }
                        else if (thisCovid.fips != thisSvi.FIPS) {
                            // look ahead to see which datapoint is extra
                            let nextCovid;
                            let nextSvi;

                            let j = 1
                            while(true) {
                                nextCovid = trimmedCovid[i+j];
                                nextSvi = trimmedSvi[i+j];

                                //console.log("WHILE i = "+i+"; j = "+j+"; nextCovid="+nextCovid.fips+" and nextSvi="+nextSvi.FIPS);

                                if (thisSvi.FIPS == nextCovid.fips) { // means that thisCovid needs to be removed
                                    //console.log("thisSvi: "+thisSvi.FIPS+" matches nextCovid: "+nextCovid.fips+"so I will remove "+thisCovid.fips+"and "+j+" elements after it");
                                    trimmedCovid.splice(i,j);
                                    i -= j;
                                    //console.log("Shifted i down by j,"+j+" to i="+i);
                                    break;
                                }
                                else if (thisCovid.fips == nextSvi.FIPS) { // means that thisSvi needs to be removed
                                    //console.log("thisCovid: "+thisCovid.fips+" matches nextSvi: "+nextSvi.FIPS+"so I will remove "+thisSvi.FIPS+"and "+j+" elements after it");
                                    trimmedSvi.splice(i,j);
                                    i -= j;
                                    //console.log("Shifted i down by j,"+j+" to i="+i);
                                    break;
                                }

                                if (j > 5) {
                                    console.log("Couldn't find a match for county "+thisCovid.fips+" from COVID in SVI. i = "+i);
                                    break;
                                }
                                j++;
                            }
                        }
                    } catch (e) {
                        break;
                    }
                }

                for (let i = 0; i < trimmedCovid.length; i++) {

                    let currentCovid = trimmedCovid[i];
                    let population = parseInt(trimmedSvi[i].E_TOTPOP);
                    let cases = parseInt(currentCovid.cases);
                    let deaths = parseInt(currentCovid.deaths);

                    if(cases > maxCases) {
                        maxCases = cases;
                    }
                    if(deaths > maxDeaths) {
                        maxDeaths = deaths;
                    }
                    if (cases/population > maxCasesDensity) {
                        maxCasesDensity = cases/population;
                    }
                    if (deaths/population > maxDeathsDensity) {
                        maxDeathsDensity = deaths/population;
                    }
                }

                return [trimmedCovid, trimmedSvi]
            }

            function covidFipsComparator(a,b) {
                let aFips = parseInt(a.fips);
                let bFips = parseInt(b.fips);

                return bFips - aFips;
            }

            // returns true if the state_fips is a part of the mainland US
            // exclude overseas territories, Alaska, and Hawaii
            function isStateMainlandUs(state_fips) {
                state_fips = parseInt(state_fips); // make sure its an integer
                if (state_fips <= 56 && state_fips != 02 && state_fips != 15) {
                    return true;
                } else {
                    return false;
                }
            }
            
            // returns true if the county_fips is a part of the mainland US
            // exclude overseas territories, Alaska, and Hawaii
            function isCountyMainlandUs(county_fips) {
               county_fips = parseInt(county_fips); // make sure its an integer
               let state_fips = Math.trunc(county_fips/1000); // last three integers represent the county
               return isStateMainlandUs(state_fips);
            }
            
            // getMostRecentCovid()
            //      Retrieves covid data from the S3 bucket using the signed url
            //      And throws away all data not from most recent date
            async function getMostRecentCovid() {
                console.log("Attempting to get COVID data");
                
                const request = new Request(S3_SIGNED_URL);
                var text = await fetch(request)
                    .then(response => text = response.text());
                console.log("Recieved COVID data!");
                
                //console.log(text);
                
                // look at last line in file to determine most recent date
                let lastLine = text.lastIndexOf('\n');
                let mostRecentDate = null;
                if (lastLine > 0) {
                    let comma = text.indexOf(',', lastLine);
                    mostRecentDate = text.substring(lastLine+1,comma);
                } else {
                    throw "COVID data recieved was not in csv format.";
                }
                
                // delete all lines that do not begin with the most recent date but keep header
                let header = text.substring(0, text.indexOf('\n')) + '\n';
                header = header.substring(header.indexOf(',')+1);   // remove date
                let output = header;
                if (mostRecentDate != null) {
                    let lines = text.split('\n');
                    for (let i = 1; i < lines.length; i++) { // i=1, skip header
                        let thisLine = lines[i];
                        let comma = thisLine.indexOf(',');
                        let thisDate = thisLine.substring(0,comma);
                        if (thisDate === mostRecentDate) {
                            thisLine = thisLine.substring(thisLine.indexOf(',')+1);   // remove date
                            output = output + thisLine + "\n";
                        }
                    }
                } else {
                    throw "COVID data recieved was not in csv format.";
                }
                
                //console.log(output);
                
                return output;
            }
            
            
            /*
            * Helper Functions
            */

            // Function: returns a new value that is calculated relative to the min and max
            function interpolate(value, minIn, maxIn, minOut, maxOut) {
                let rangeIn = maxIn - minIn;
                let percentIn = (value - minIn) / rangeIn;
                let rangeOut = maxOut - minOut;
                return percentIn * rangeOut + minOut;
            }

            // Function: returns a formatted version of the given Date object in the form: yyyymmdd2100 (EX: 202008022100)
            function getFormattedDate(date) {

                var year = date.getUTCFullYear().toString();
                var month = (date.getUTCMonth()+1).toString().padStart(2, '0'); // padStart adds a leading 0 if needed
                var day = (date.getUTCDate()).toString().padStart(2, '0');

                return year + month + day + '2100';
            }

            // Function: Converts .csv data to JSON
            function CSVtoJSON(csvFile) {
                var lines = csvFile.split("\n");
                var toJSON = [];
                var headers = lines[0].split(",");

                for(var i = 1; i < lines.length; i++){
                	  var obj = {};
                	  var currentline = lines[i].split(",");

                	  for(var j = 0; j < headers.length; j++){
                		  obj[headers[j]] = currentline[j];
                	  }

                	  toJSON.push(obj);
                }

                return JSON.stringify(toJSON);
            }
            /*
            // Function: finds the interquartile range specifically for the covid dataset
            function calculateCovidIQR() {
                let length = covid.length;
                let casesInOrder = [];
                let deathsInOrder = [];
                let casesDensitiesInOrder = [];
                let deathsDensitiesInOrder = [];

                for (var i = 0; i < length; i++) {
                    casesInOrder.push(parseInt(covid[i].cases));
                    deathsInOrder.push(parseInt(covid[i].deaths));
                    casesDensitiesInOrder.push(parseFloat(covid[i].cases / svi[i].E_TOTPOP));
                    deathsDensitiesInOrder.push(parseFloat(covid[i].deaths / svi[i].E_TOTPOP));
                }

                casesInOrder.sort(function(a, b){return a-b});
                deathsInOrder.sort(function(a, b){return a-b});
                deathsDensitiesInOrder.sort(function(a, b){return a-b});
                casesDensitiesInOrder.sort(function(a, b){return a-b});

                // calculate and save quartiles to global variables

                casesQ1 = casesInOrder[ parseInt( length / 4 ) ];
                casesQ3 = casesInOrder[ parseInt( 3 * length / 4 ) ];

                deathsQ1 = deathsInOrder[ parseInt( length / 4 ) ];
                deathsQ3 = deathsInOrder[ parseInt( 3 * length / 4 ) ];

                casesDensityQ1 = casesDensitiesInOrder[ parseInt( length / 4 ) ];
                casesDensityQ3 = casesDensitiesInOrder[ parseInt( 3 * length / 4 ) ];

                deathsDensityQ1 = deathsDensitiesInOrder[ parseInt( length / 4 ) ];
                deathsDensityQ3 = deathsDensitiesInOrder[ parseInt( 3* length / 4 ) ];
            }*/

            // tries to outputs a human readable form of a percent decimal in the form of "___ in every ___"
            function oneInEvery(percentDecimal) {

                if (percentDecimal <= 0) {
                    return percentDecimal;
                }

                let multiple = 0;
                while (percentDecimal < 1) {
                    percentDecimal *= 10;
                    multiple++;
                }
                percentDecimal = Math.round(percentDecimal);

                return percentDecimal + " in every " + numberWithCommas(Math.pow(10,multiple));
            }

            // adds commas every thousands place
            function numberWithCommas(x) {
                return x.toLocaleString('en-us');
            }

            function formatOutput(feature, key) {

                let sviThemes = ["sviOverall","sviSocioeconomics","sviHouseholdComposition","sviMinority","sviHousing"];

                if (feature.properties[ key ] != null) { // if not null
                    // if the variable name has the word 'Percentile' in it or if its an aggregate SVI theme
                    if (key.indexOf("Percentile") != - 1 || sviThemes.includes(key)) {
                            return ( parseFloat(feature.properties[ key ]) * 100 ).toFixed(1) + "<sup>th</sup>";
                    }

                    // else if has it has 'Percent' in it
                    else if (key.indexOf("Percent") != -1 ) {
                        return parseFloat(feature.properties[ key ]).toFixed(2) + "%";
                    }

                    else if (key == "sviIncome") {
                        return "$" + numberWithCommas( parseFloat( feature.properties[ key ] ) );
                    }

                    else {
                        return parseFloat(feature.properties[ key ]).toFixed(2) + "";
                    }
                }
                else { // if not
                    return "No Data";
                }
            }

            function isChrome() {
                var isChromium = window.chrome;
                var winNav = window.navigator;
                var vendorName = winNav.vendor;
                var isOpera = typeof window.opr !== "undefined";
                var isIEedge = winNav.userAgent.indexOf("Edge") > -1;
                var isIOSChrome = winNav.userAgent.match("CriOS");

                if (isIOSChrome) {
                   // is Google Chrome on IOS
                } else if(
                  isChromium !== null &&
                  typeof isChromium !== "undefined" &&
                  vendorName === "Google Inc." &&
                  isOpera === false &&
                  isIEedge === false
                ) {
                   // is Google Chrome
                   return true;
                } else {
                   // not Google Chrome
                   return false;
                }
            }

            function geoJSONSviComparator(a,b) {
                return parseFloat(a.properties[currentSviLayer]) - parseFloat(b.properties[currentSviLayer])
            }

        </script>

        <!--Load C3 scripts-->
        <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
        <script src="https://cdn.jsdelivr.net/npm/c3@0.7.20/c3.min.js"></script>

        <script src="/scripts/data-panel-graphs.js"></script>

    </body>
</html>
