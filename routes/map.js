// Imports
const express = require("express");
const whiskers = require("whiskers");
var fs = require('fs');
const AWS = require('aws-sdk');

// Router
const router = express.Router();

// Environment Variables
require('dotenv').config();
const AWS_ACCESS_KEY = process.env.AWS_ACCESS_KEY || 'no key found';
const AWS_SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY || 'no key found';

// get signed url that client will use to download COVID data from the S3 bucket
var S3 = new AWS.S3({
                accessKeyId: AWS_ACCESS_KEY,
                secretAccessKey: AWS_SECRET_ACCESS_KEY,
            });

const BUCKET_NAME = 'us-counties-cases-datas3bucket-52y13214tdyo';
const KEY = "covid-19-nyt-data-in-usa/dataset/us-counties.csv";
const EXPIRE_TIME = 60 * 100; // expiry time in seconds

// Handle the get for this route
router.get("/", (req, res) => {
    //res.render("./public/home.html");
    
    const URL = S3.getSignedUrl('getObject', {
        Bucket: BUCKET_NAME,
        Key: KEY,
        Expires: EXPIRE_TIME
    });
    
    var template = fs.readFileSync('./public/map.html');
    var rendered = whiskers.render(template, {
        signed_url: URL
    });
    res.send(rendered);
});

router.post('/', function(req, res, next) {
 // Handle the post for this route
});

module.exports = router;